name: Publish Staging to NPM
on:
  push:
    branches:
      - staging
jobs:
  Publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
      - name: Install
        run: bun i
      - name: Typecheck
        run: bunx tsgo -p ./tsconfig.json
      - name: Set staging version
        run: |
          BASE_VERSION=$(jq -r .version package.json)
          SHORT_SHA=$(git rev-parse --short HEAD)
          STAGING_VERSION="${BASE_VERSION}-staging.${SHORT_SHA}"
          jq --arg v "$STAGING_VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json
          echo "Publishing version: $STAGING_VERSION"
      - name: Publish with staging tag
        run: NPM_CONFIG_TOKEN=${{secrets.NPM_CONFIG_TOKEN}} bun publish --tag staging
